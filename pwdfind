#!/usr/bin/env bash

set -e

# Check search term
if [[ -z "$1" ]]; then
    echo "Usage: $0 <search-term>"
    exit 1
fi

if [[ -z "$KP_DB_PATH" ]]; then
    echo "KP_DB_PATH environment variable not set."
    exit 2
fi

if [[ -z "$KP_DB_PASS" ]]; then
    echo "KP_DB_PASS environment variable not set."
    exit 3
fi

SEARCH_TERM="$1"
DB="$KP_DB_PATH"
PASS="$KP_DB_PASS"

# Function to run keepassxc-cli with password from env
kxc() {
    echo -n "$PASS" | keepassxc-cli "$@"
}

# Search
entries=$(kxc search "$DB" "$SEARCH_TERM" | grep -v '^Search results:' | grep -v '^$')

# Count results
results=()
while IFS= read -r line; do
    results+=("$line")
done <<< "$entries"

count="${#results[@]}"

if [[ $count -eq 0 ]]; then
    echo "No entries found for '$SEARCH_TERM'."
    exit 0
elif [[ $count -eq 1 ]]; then
    entry="${results[0]}"
else
    echo "Multiple entries found:"
    for i in "${!results[@]}"; do
        echo "$((i+1)): ${results[i]}"
    done
    read -p "Select entry [1-$count]: " sel
    if ! [[ "$sel" =~ ^[0-9]+$ ]] || [[ "$sel" -lt 1 ]] || [[ "$sel" -gt $count ]]; then
        echo "Invalid selection."
        exit 4
    fi
    entry="${results[$((sel-1))]}"
fi

echo
echo "----- ENTRY INFO -----"
kxc show --show-protected "$DB" "$entry"

echo
echo "Copying username to clipboard (UserName)..."
kxc clip -a UserName "$DB" "$entry" 0
echo "Username is in clipboard. Press ENTER to copy password."
read

kxc clip "$DB" "$entry"
